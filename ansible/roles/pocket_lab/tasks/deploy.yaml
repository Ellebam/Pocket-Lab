- name: Create compose directory
  file:
    path: "{{ compose_repo }}"
    state: directory

- name: Copy stack files
  copy:
    src: "{{ item }}"
    dest: "{{ compose_repo }}/{{ item | basename }}"
    mode: "0644"
  with_fileglob:
  - "{{ role_path }}/files/*"

- name: Render .env file
  template:
    src: .env.j2
    dest: "{{ compose_repo }}/.env"
    mode: "0640"

- name: Launch stack
  community.docker.docker_compose_v2:
    project_src: "{{ compose_repo }}"
    pull: missing
    state: present
