---
name: Create Release

"on":
  push:
    tags:
      - "v*"

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: debug-context
        run: |
          echo "Tag: ${GITHUB_REF_NAME}"
          echo "--- HEAD of CHANGELOG.md ---"
          head -n 20 CHANGELOG.md
          echo "----------------------------"

      - name: Extract release notes
        id: extract_notes
        shell: python
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          import os
          import sys

          tag = os.environ["TAG_NAME"]
          file_path = "CHANGELOG.md"
          # The expected header format, exactly as in your file
          target_header = f"## [{tag}]"

          print(f"Looking for header: '{target_header}' in {file_path}")

          found_entry = False
          extracted_lines = []

          try:
              with open(file_path, "r") as f:
                  for line in f:
                      # 1. Find the start header
                      if not found_entry:
                          if line.strip().startswith(target_header):
                              found_entry = True
                              continue # Skip the header line itself
                          continue

                      # 2. Stop at the next release header (starts with ## [)
                      if line.strip().startswith("## ["):
                          break

                      # 3. Collect lines
                      extracted_lines.append(line)

              # Check results
              if not found_entry:
                  print(f"Error: Could not find header '{target_header}'")
                  sys.exit(1)

              content = "".join(extracted_lines).strip()
              if not content:
                  print("Error: Header found, but release notes body is empty.")
                  sys.exit(1)

              # Write to file
              with open("release_body.md", "w") as f:
                  f.write(content)

              print("Successfully extracted release notes.")

          except FileNotFoundError:
              print(f"Error: {file_path} not found in the repository.")
              sys.exit(1)

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_body.md
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
